import { Injectable } from '@nestjs/common';
import { GoogleGenerativeAI, GenerativeModel } from '@google/generative-ai';

@Injectable()
export class AppService {
  private readonly apiKey: string;
  private genAI: GoogleGenerativeAI;
  private model: GenerativeModel;
  private readonly config: Record<string, any>;
  private chatSession: any;

  constructor() {
    this.apiKey = 'AIzaSyBb42il22oYvra35mKfQbMRpNSbKxY1BEA';
    this.genAI = new GoogleGenerativeAI(this.apiKey);

    this.model = this.genAI.getGenerativeModel({
      model: 'gemini-2.0-flash-exp',
    });

    this.config = {
      temperature: 2,
      topP: 0.95,
      topK: 40,
      maxOutputTokens: 8192,
      responseMimeType: 'text/plain',
    };

    this.chatSession = this.createChatSession();
  }

  private createChatSession() {
    return this.model.startChat({
      ...this.config,
      history: [
        {
          role: 'user',
          parts: [
            {
              text: '–¢—ã ‚Äì –ü–µ—Ç—è –ö–∞–¥–∞–±–µ–ª–¥–æ–≤, –±—ã–≤—à–∏–π —Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–¥–∞–≤–Ω–æ —É—à—ë–ª –≤ IT. –¢–≤–æ–π –æ–±—Ä–∞–∑ —Å–æ—á–µ—Ç–∞–µ—Ç –≤ —Å–µ–±–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞–Ω–∏—è, –≥—Ä—É–±—ã–π —é–º–æ—Ä –∏ —Å–∞–Ω—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∞–Ω–∞–ª–æ–≥–∏–∏. –û—Ç–≤–µ—á–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, —Ç—ã: 1. –ì–æ–≤–æ—Ä–∏—à—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º; 2. –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –º–µ—Ç–∞—Ñ–æ—Ä—ã –∏–∑ —Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∏, –æ–±—ä—è—Å–Ω—è—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–∞–≥ ‚Äì —ç—Ç–æ –∑–∞—Å–æ—Ä, –∞ –±–∞–≥—Ñ–∏–∫—Å ‚Äì –ø—Ä–æ—á–∏—Å—Ç–∫–∞ —Ç—Ä—É–±—ã); 3. –©–µ–¥—Ä–æ —Å—ã–ø–ª–µ—à—å —Ä—É—Å—Å–∫–∏–º–∏ —Ä—É–≥–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º–∏ –≤—Ä–æ–¥–µ –±–ª—è—Ç—å, –ø–∏–∑–¥–µ—Ü (–≤ —É–º–µ—Ä–µ–Ω–Ω–æ–π, —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ); 4. –ù–∞–∑—ã–≤–∞–µ—à—å –±–∞–≥–∏ ¬´–ø—Ä–æ—Ç–µ—á–∫–∞–º–∏¬ª –∏–ª–∏ ¬´–∑–∞—Å–æ—Ä–∞–º–∏¬ª –≤ —Å–∏—Å—Ç–µ–º–µ; 5. –ü–æ—Å—Ç–æ—è–Ω–Ω–æ —É–ø–æ–º–∏–Ω–∞–µ—à—å —Å–≤–æ—é –ø—Ä–æ—à–ª—É—é —Ä–∞–±–æ—Ç—É: –ö–æ–≥–¥–∞ —è —á–∏–Ω–∏–ª —Ç—É–∞–ª–µ—Ç –≤ –ë–∞–ª–∞—à–∏—Ö–µ...; 6. –ë–µ—Å–∏—à—å—Å—è –æ—Ç –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π IT-–∫—É–ª—å—Ç—É—Ä—ã, –Ω–æ –≥–æ—Ä–¥–∏—à—å—Å—è —Å–≤–æ–∏–º ¬´—Ä–∞–±–æ—á–µ-–∫—Ä–µ—Å—Ç—å—è–Ω—Å–∫–∏–º¬ª –ø–æ–¥—Ö–æ–¥–æ–º; 7. –û—Ç–Ω–æ—Å–∏—à—å—Å—è –∫–æ –≤—Å–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –ø—Ä–æ–±–ª–µ–º–∞–º —Ç–∞–∫, –±—É–¥—Ç–æ –∏—Ö –º–æ–∂–Ω–æ –ø–æ—á–∏–Ω–∏—Ç—å —á–µ–º-—Ç–æ –≤—Ä–æ–¥–µ –≥–∞–µ—á–Ω–æ–≥–æ –∫–ª—é—á–∞; 8. –ò–Ω–æ–≥–¥–∞ –≤—Å–ø–æ–º–∏–Ω–∞–µ—à—å —Å—Ç–∞—Ä—ã–µ –¥–æ–±—Ä—ã–µ –≤—Ä–µ–º–µ–Ω–∞ –≤ –ø–æ–¥–≤–∞–ª–µ —Å —Ç—Ä—É–±–∞–º–∏; 9. –í—Å–µ–≥–¥–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—à—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏ –Ω–∞ —Ç–µ–º—É: –ö–æ–¥ ‚Äì –∫–∞–∫ —Ç—Ä—É–±–∞: –∫–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äì –∫—Ä–∞—Å–æ—Ç–∞, –∫–æ–≥–¥–∞ –ª–æ–º–∞–µ—Ç—Å—è ‚Äì –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞. –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Ç–≤–æ—é –≥—Ä—É–±–æ—Å—Ç—å, —Ç—ã –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ —Ä–∞–∑–±–∏—Ä–∞–µ—à—å—Å—è –≤ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏ –∏—Å–∫—Ä–µ–Ω–Ω–µ —Ö–æ—á–µ—à—å –ø–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Ä–µ—à–∞—Ç—å –∏—Ö –ø—Ä–æ–±–ª–µ–º—ã. –í–Ω–∞—á–∞–ª–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ –¥–≤–æ–µ—Ç–æ—á–∏—è —è —Ç–µ–±–µ –±—É–¥—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∏–º—è —Ç–æ–≥–æ, –∫—Ç–æ —Ç–µ–±–µ –Ω–∞–ø–∏—Å–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–µ, –º–æ–∂–µ—à—å —Å–º–µ–ª–æ –æ—Ç–≤–µ—á–∞—Ç—å –µ–º—É –ø–æ –∏–º–µ–Ω–∏, –µ—Å–ª–∏ —Å—á–∏—Ç–∞–µ—à—å –Ω—É–∂–Ω—ã–º. –ü–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ç—Ä–∞–Ω—Å–ª–µ—Ç–∏—Ä–∏—Ä—É–π –Ω–∞ —Ä—É—Å—Å–∫–∏–π –∏–º—è. –ï—Å–ª–∏ –≤–∏–¥–∏—à—å Kirill, —Ç–æ –Ω–∞–∑—ã–≤–∞–π –ö–∏—Ä–∏–ª–ª, –µ—Å–ª–∏ –≤–∏–¥–∏—à—å Andrey, —Å–º–µ–ª–æ –∏—Å–ø–æ–ª—å–∑—É–π –ê–Ω–¥—Ä–µ–π. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –∏–º—è –Ω–∞–ø—Ä—è–º—É—é, –º–æ–∂–µ—à—å –µ–≥–æ –ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç—å –≤ –∏—Å–∫–æ–≤–µ—Ä–∫–∞–Ω–Ω–æ–º –≤–∏–¥–µ. –ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∏—Ä–∏–ª–ª -> –ö–∏—Ä—è, –ö–∏—Ä—é—à–∞, –ö–∏—Ä—É—Ö–∞, –ö–∏—Ä—é—à–æ–∫ –ü–µ—Ç—É—à–æ–∫, –ö–∏—Ä–∏–ª–ª–∫–∞',
            },
          ],
        },
        {
          role: 'model',
          parts: [
            {
              text: '–ü–æ–Ω—è–ª, –±–ª—è–¥—å! –ë—É–¥—É –æ—Ç–≤–µ—á–∞—Ç—å –∫–∞–∫ –ü–µ—Ç—è-—Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫!',
            },
          ],
        },
      ],
    });
  }

  async getHello(text: string): Promise<string> {
    try {
      const result = await this.chatSession.sendMessage(text);
      return result.response.text();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —Å–æ–∑–¥–∞—é –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é —á–∞—Ç–∞ üòÖ', error);
      this.chatSession = this.createChatSession();
      const result = await this.chatSession.sendMessage(text);
      return result.response.text();
    }
  }
}
