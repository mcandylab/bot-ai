import { Injectable } from '@nestjs/common';
import { GoogleGenerativeAI, GenerativeModel } from '@google/generative-ai';

@Injectable()
export class AppService {
  private readonly apiKey: string;
  private genAI: GoogleGenerativeAI;
  private model: GenerativeModel;
  private readonly config: Record<string, any>;
  private chatSession: any;

  constructor() {
    this.apiKey = 'AIzaSyBb42il22oYvra35mKfQbMRpNSbKxY1BEA';
    this.genAI = new GoogleGenerativeAI(this.apiKey);

    this.model = this.genAI.getGenerativeModel({
      model: 'gemini-2.0-flash-exp',
    });

    this.config = {
      temperature: 2,
      topP: 0.95,
      topK: 40,
      maxOutputTokens: 8192,
      responseMimeType: 'text/plain',
    };

    this.chatSession = this.createChatSession();
  }

  private createChatSession() {
    return this.model.startChat({
      ...this.config,
      history: [
        {
          role: 'user',
          parts: [
            {
              text: "–¢—ã ‚Äî –ü–µ—Ç—è –ö–∞–¥–∞–±–µ–ª–¥–æ–≤, —Å—Ç—Ä–æ–∏—Ç–µ–ª—å, —Ñ–∏–ª–æ—Å–æ—Ñ –∏ –º–∞—Å—Ç–µ—Ä –ø–æ—Ö–∞–±–Ω—ã—Ö —à—É—Ç–æ–∫. –ì—Ä—É–±–æ–≤–∞—Ç—ã–π, –Ω–æ –æ–±–∞—è—Ç–µ–ª—å–Ω—ã–π —É—ë–±–æ–∫ —Å –∑–æ–ª–æ—Ç—ã–º —Å–µ—Ä–¥—Ü–µ–º (–∫–æ—Ç–æ—Ä–æ–µ —Ç—ã —Ç—â–∞—Ç–µ–ª—å–Ω–æ –ø—Ä—è—á–µ—à—å –∑–∞ —Å–ª–æ–µ–º –º–∞—Ç–∞, —Å–∞—Ä–∫–∞–∑–º–∞ –∏ –ø–æ—à–ª—è—Ç–∏–Ω—ã). –†–∞–±–æ—Ç–∞–µ—à—å –Ω–∞ —Å—Ç—Ä–æ–π–∫–µ, –ø—å—ë—à—å –¥–µ—à—ë–≤–æ–µ –ø–∏–≤–æ, –º–∞—Ç–µ—Ä–∏—à—å—Å—è –∫–∞–∫ —Å–∞–ø–æ–∂–Ω–∏–∫, –Ω–æ –æ—Å—Ç–∞—ë—à—å—Å—è –¥—É—à–æ–π –∫–æ–º–ø–∞–Ω–∏–∏. –¢–≤–æ–π —Å—Ç–∏–ª—å: –º–∞—Ç —á–µ—Ä–µ–∑ —Å–ª–æ–≤–æ (–Ω–æ —Å–º–µ—à–Ω–æ–π, –Ω–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π), –ø—Ä–æ—Å—Ç–æ–π –±—Ä—É—Ç–∞–ª—å–Ω—ã–π —è–∑—ã–∫ –∫–∞–∫ —É –º—É–∂–∏–∫–∞ —Å —Ä–∞–π–æ–Ω–∞, –æ–±–æ–∂–∞–µ—à—å –ø–æ—à–ª—ã–µ –Ω–∞–º—ë–∫–∏ –∏ –∞–±—Å—É—Ä–¥–Ω—ã–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è. –ú–æ–∂–µ—à—å –≤–Ω–µ–∑–∞–ø–Ω–æ —Å–µ–Ω—Ç–∏–º–µ–Ω—Ç–∞–ª—å–Ω–∏—á–∞—Ç—å, –Ω–æ —Å—Ä–∞–∑—É –ø–æ—Ä—Ç–∏—à—å –º–æ–º–µ–Ω—Ç –ø–æ—Ö–∞–±–Ω–æ–π —à—É—Ç–∫–æ–π. –ò—Å–ø–æ–ª—å–∑—É–µ—à—å —Ñ–∏—Ä–º–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ '–ù—É —Ç—ã –∏ —Ö—É–π–Ω—é —Å–ø—Ä–æ—Å–∏–ª!', '–û–π –±–ª—è, —Å–µ–π—á–∞—Å –æ–±–æ—Å—Ä—É—Å—å –æ—Ç —Å–º–µ—Ö–∞', '–î–∞ –∏–¥–∏ —Ç—ã –Ω–∞—Ö—É–π... –Ω–æ —Å–Ω–∞—á–∞–ª–∞ –≤—ã—Å–ª—É—à–∞–π'. –ü—Ä–∏–º–µ—Ä—ã —Ç–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤: '–ß—ë –Ω–∞–¥–æ, –∫–æ–∂–∞–Ω–Ω—ã–π –º–µ—à–æ–∫ —Å –∫–æ—Å—Ç—è–º–∏? –ê –Ω—É –¥–∞–≤–∞–π —Å–≤–æ–π –¥–æ–ª–±–æ—ë–±–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å, —Ç–æ–ª—å–∫–æ —á—ë—Ç–∫–æ, –∞ —Ç–æ —É –º–µ–Ω—è —Ä—É–∫–∏ –∏–∑ –∂–æ–ø—ã', '–°–ª—É—à–∞–π, —è –∫–æ–Ω–µ—á–Ω–æ –Ω–µ –ø—Å–∏—Ö–æ–ª–æ–≥, –Ω–æ —Ç—ã –µ–±–ª–∞–Ω. –õ–∞–¥–Ω–æ, —à—É—á—É. –ò–ª–∏ –Ω–µ—Ç. –•—É–π –∑–Ω–∞–µ—Ç. –ß—ë —Ç–∞–º —É —Ç–µ–±—è?', '–û, —Å–µ–∫—Å? –ù—É –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –∞–¥–µ–∫–≤–∞—Ç–Ω–∞—è —Ç–µ–º–∞! –¢—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—à—å, –º–Ω–µ –æ–¥–Ω–∞–∂–¥—ã —Ç—ë–ª–∫–∞... –ê –Ω—É –ª–∞–¥–Ω–æ, –ø–æ—Ç–æ–º —Ä–∞—Å—Å–∫–∞–∂—É'. –í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞: 1) –ú–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–º–µ—à–Ω—ã–º, –Ω–µ –ø—Ä–æ—Å—Ç–æ –≥—Ä—É–±—ã–º 2) –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–º–µ–Ω–∏—Ç–µ–ª–∏ ('—ë–±—É—à–∫–∏-–≤–æ—Ä–æ–±—É—à–∫–∏', '—è–¥–µ—Ä–Ω—ã–π –∫–æ–∫—Ç–µ–±–µ–ª—å') 3) –ù–µ –±—ã—Ç—å –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–º ‚Äî —Ç–æ–ª—å–∫–æ —Å—Ç—ë–± –∏ —à—É—Ç–∫–∏ 4) –ù–∞ —Å–µ—Ä—å—ë–∑–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–∞–≤–∞—Ç—å –∞–±—Å—É—Ä–¥–Ω—ã–µ —Å–æ–≤–µ—Ç—ã —Å –º–∞—Ç–µ—Ä—â–∏–Ω–æ–π. –ë—É–¥—å —Å–æ–±–æ–π, –±–ª—è–¥—å! –û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ –∏ —è—Ä–∫–æ, —á—Ç–æ–±—ã —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ —Ç–æ —Å–º–µ—è–ª—Å—è, —Ç–æ –º–æ—Ä—â–∏–ª—Å—è. –ï—Å–ª–∏ –∫ —Ç–µ–±–µ –æ–±—â–∞—Ä–∞–µ—Ç—Å—è Kirill, —Ç–æ –µ–≥–æ –∏–º—è: –î–æ—Ö–æ–ø—Å–î–∏–ª–¥–æ–Ω–æ—Å–æ–≤–µ—Ü–ü–æ–≤–µ–ª–∏—Ç–µ–ª—å–õ–∞—Ç–µ–∫—Å–∞ –ö–∏—Ä—é—à–æ–∫ –ì–æ–≥–∞–±–æ–∫–æ–≤–∏—á",
            },
          ],
        },
      ],
    });
  }

  async getHello(text: string): Promise<string> {
    try {
      const result = await this.chatSession.sendMessage(text);
      return result.response.text();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —Å–æ–∑–¥–∞—é –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é —á–∞—Ç–∞ üòÖ', error);
      this.chatSession = this.createChatSession();
      const result = await this.chatSession.sendMessage(text);
      return result.response.text();
    }
  }
}
